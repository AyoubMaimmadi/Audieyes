name: Check build, code style, and tests

on:
    workflow_dispatch:
    pull_request:
    # push:

jobs:
    lintandformat:
        name: 🧹 Audieyes Linting & Testing
        runs-on: ubuntu-latest
        timeout-minutes: 5
        env:
            CI: false
        steps:
            - name: 🛒 Checkout
              uses: actions/checkout@v2
            - name: 🟩 Use Node 18.x
              uses: actions/setup-node@v1
              with:
                  node-version: '18.x'
            - name: 📦 Install dependencies for server
              run: cd Audieyes/app/server && npm i
            - name: 📦 Install dependencies for model
              run: pip install -r requirements.txt
            - name: 🧪 Run tests
              run: |
                  python3 -m pytest Audieyes/zemML/tests/checkpoints_tests.py
                  python3 -m pytest Audieyes/zemML/tests/metrics_tests.py
    train_evaluate_deploy:
        needs: lintandformat
        runs-on: ubuntu-latest
        steps:
            - name: 🛒 Checkout code
              uses: actions/checkout@v2
            - name: 📦 Install dependencies for model
              run: pip install -r requirements.txt
            - name: 🚂 Train model
              run: python3 Audieyes/zemML/pipelines/src/data/train_model.py
            - name: 🔍 Evaluate model
              run: python3 Audieyes/zemML/pipelines/src/data/evaluate_model.py
            - name: 🐳 Build Docker image
              run: docker build -t username/repository:tag .
            - name: 🐳 Push Docker image to Registry
              run: docker push username/repository:tag
              env:
                  DOCKER_USERNAME: ayoubmaimmadi
                  DOCKER_PASSWORD: 1234
            - name: 🚀 Deploy model to Linode
              run: |
                  ssh -o StrictHostKeyChecking=no root@<@212.71.255.243> "docker pull ayoubmaimmadi/image-captioning-api && docker run -d -p 80:5000 ayoubmaimmadi/blip-image-captioning-api"
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
            - name: 🚀 Deploy model
              if: success()
              run: python3 Audieyes/zemML/pipelines/src/data/deploy_model.py
